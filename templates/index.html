<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>FitMood AI</title>

  <!-- Template CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/templatemo-chain-app-dev.css') }}" />

  <!-- Google Fonts Raleway -->
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;600&display=swap" rel="stylesheet" />

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Ajout styles perso */
    #generate-music-btn {
      cursor: pointer;
    }
    #feedback-section {
      display: none;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="#">
        <img src="{{ url_for('static', filename='image/logo.png') }}" alt="Fit Melody Logo" style="height: 40px;" />
        FitMelody
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="#biometrics">Biometrics</a></li>
          <li class="nav-item"><a class="nav-link" href="#charts">History</a></li>
          <li class="nav-item"><a class="nav-link" href="#profile">Music</a></li>
          <li class="nav-item">
            <!-- Lien vers ton endpoint /authorize -->
            <a href="/authorize" class="btn btn-primary ms-lg-3">Start</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero section -->
  <section class="hero-section pt-5">
    <div class="container text-center">
      <h1>ğŸµğŸµ FitMelody ğŸµğŸµ</h1>
      <p class="mb-5">Transform your biometrics into personalized relaxing music</p>
      <img src="{{ url_for('static', filename='image/image1.jpeg') }}" alt="Relax AI Watch" class="img-fluid rounded shadow" style="max-width: 300px;" />
      <p class="mt-4">
        Relaxing with music generated from your own heartbeat. The future of personalized wellness is here.
      </p>
    </div>
  </section>

  <!-- Main content -->
  <main class="container my-5">
    <!-- Biometric Data -->
    <section id="biometrics" class="mb-5">
      <h2 class="mb-4">ğŸ“Š Biometric Data (Live from Fitbit)</h2>
      <div class="row g-3">
        <div class="col-md-4"><div class="card p-3 shadow-sm">ğŸ“… Date: <span id="date-val">-</span></div></div>
        <div class="col-md-4"><div class="card p-3 shadow-sm">ğŸ•’ Time: <span id="time-val">-</span></div></div>
        <div class="col-md-4"><div class="card p-3 shadow-sm">â¤ï¸ Heart Rate: <span id="bpm-val">...</span> BPM</div></div>

        <div class="col-md-4"><div class="card p-3 shadow-sm">ğŸ”¥ Calories: <span id="cal-val">...</span></div></div>
        <div class="col-md-4"><div class="card p-3 shadow-sm">ğŸª‘ Sedentary Minutes: <span id="sedentary-val">...</span></div></div>
        <div class="col-md-4"><div class="card p-3 shadow-sm">ğŸƒ Steps: <span id="steps-val">...</span></div></div>

        <div class="col-md-4"><div class="card p-3 shadow-sm">ğŸ’¤ Asleep: <span id="asleep-val">...</span> min</div></div>
        <div class="col-md-4"><div class="card p-3 shadow-sm">âš¡ Efficiency: <span id="eff-val">...</span>%</div></div>
        <div class="col-md-4"><div class="card p-3 shadow-sm">ğŸŒ™ REM: <span id="rem-val">...</span> min</div></div>

        <div class="col-md-4"><div class="card p-3 shadow-sm">ğŸ›Œ Deep: <span id="deep-val">...</span> min</div></div>
        <div class="col-md-4"><div class="card p-3 shadow-sm">â° Wake: <span id="wake-val">...</span> min</div></div>
      </div>

      <button id="generate-music-btn" class="btn btn-primary btn-lg mt-4" style="display:none;">
        ğŸµ Generate Music
      </button>

      <p id="status-msg" class="mt-3 fw-bold"></p>
    </section>

    <!-- Charts Section -->
    <section id="charts" class="mb-5">
      <h2>ğŸ“ˆ 60 Last Minutes Graph</h2>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card p-3 shadow-sm">
            <h5>â¤ï¸ Heart Rate</h5>
            <canvas id="chart-heart"></canvas>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card p-3 shadow-sm">
            <h5>ğŸƒ Steps</h5>
            <canvas id="chart-steps"></canvas>
          </div>
        </div>
        <div class="col-md-6 mt-4">
          <div class="card p-3 shadow-sm">
            <h5>ğŸ”¥ Calories</h5>
            <canvas id="chart-calories"></canvas>
          </div>
        </div>
        <div class="col-md-6 mt-4">
          <div class="card p-3 shadow-sm">
            <h5>ğŸª‘ Sedentary Minutes</h5>
            <canvas id="chart-sedentary"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- Music & Feedback -->
    <section id="profile" class="mb-5">
      <h2 class="mb-4">ğŸ¶ AI Music Profile</h2>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="card p-4 shadow-sm" style="min-height: 140px;">
            <h5>ğŸ§ Generated Profile</h5>
            <p id="profile-info">Click "Generate Music" to see results.</p>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card p-4 shadow-sm text-center">
            <h5>â–¶ï¸ Now Playing</h5>
            <p id="track-name" class="mb-3">-</p>
            <audio id="audio-player" controls style="display:none; opacity:0; transition: opacity 0.6s;">
              <source id="audio-src" src="#" type="audio/mp3" />
              Your browser does not support the audio element.
            </audio>
          </div>
        </div>
      </div>

      <div id="feedback-section" class="mt-4">
        <h5>â­ Donnez votre avis</h5>
        <div class="stars" style="justify-content: center;">
          <span class="star" data-value="1" style="font-size: 2rem; cursor: pointer;">â˜…</span>
          <span class="star" data-value="2" style="font-size: 2rem; cursor: pointer;">â˜…</span>
          <span class="star" data-value="3" style="font-size: 2rem; cursor: pointer;">â˜…</span>
          <span class="star" data-value="4" style="font-size: 2rem; cursor: pointer;">â˜…</span>
          <span class="star" data-value="5" style="font-size: 2rem; cursor: pointer;">â˜…</span>
        </div>
        <p class="feedback-msg" id="feedback-msg"></p>
      </div>
    </section>
  </main>

  <!-- Template JS -->
  <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>

  <script>
    // Fonction pour dessiner un graphique avec Chart.js
    async function renderChart(endpoint, canvasId, label) {
      const res = await fetch(`/${endpoint}`);
      const data = await res.json();
      const times = data.map(d => d.time);
      const values = data.map(d => d.value);
      new Chart(document.getElementById(canvasId), {
        type: "line",
        data: {
          labels: times,
          datasets: [
            {
              label,
              data: values,
              fill: false,
              borderWidth: 2,
              borderColor: "#4a90e2",
              backgroundColor: "#4a90e2",
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            x: { display: true, title: { display: true, text: "Time" } },
            y: { display: true, title: { display: true, text: label } },
          },
        },
      });
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const btnGenerate = document.getElementById("generate-music-btn");
      const statusMsg = document.getElementById("status-msg");

      try {
        // VÃ©rifie la connexion Fitbit aprÃ¨s callback
        const res = await fetch("/biometrics", { redirect: "manual" });
        if (res.status === 302) {
          return; // non autorisÃ© â†’ on reste sur la page (Start redirige vers /authorize)
        }
        const data = await res.json();
        document.getElementById("date-val").textContent = data.date || "-";
        document.getElementById("time-val").textContent = data.time || "-";
        document.getElementById("bpm-val").textContent = data.bpm || "-";
        document.getElementById("cal-val").textContent = data.calories || "-";
        document.getElementById("sedentary-val").textContent = data.sedentary || "-";
        document.getElementById("steps-val").textContent = data.steps || "-";
        document.getElementById("asleep-val").textContent = data.asleep || "-";
        document.getElementById("eff-val").textContent = data.eff || "-";
        document.getElementById("rem-val").textContent = data.rem || "-";
        document.getElementById("deep-val").textContent = data.deep || "-";
        document.getElementById("wake-val").textContent = data.wake || "-";

        btnGenerate.style.display = "inline-block";
        await renderChart("heart_history", "chart-heart", "Heart Rate (BPM)");
        await renderChart("steps_history", "chart-steps", "Steps");
        await renderChart("calories_history", "chart-calories", "Calories");
        await renderChart("sedentary_history", "chart-sedentary", "Sedentary Minutes");
      } catch (err) {
        console.error(err);
      }
    });

    let lastPrompt = "",
      lastInputText = "";
    document.getElementById("generate-music-btn").addEventListener("click", async () => {
      const statusMsg = document.getElementById("status-msg");
      statusMsg.textContent = "ğŸ¶ GÃ©nÃ©ration en cours... Veuillez patienter...";
      statusMsg.style.color = "#fab1a0";

      const biometricData = {
        date: document.getElementById("date-val").textContent,
        time: document.getElementById("time-val").textContent,
        bpm: document.getElementById("bpm-val").textContent,
        calories: document.getElementById("cal-val").textContent,
        sedentary: document.getElementById("sedentary-val").textContent,
        steps: document.getElementById("steps-val").textContent,
        asleep: document.getElementById("asleep-val").textContent,
        eff: document.getElementById("eff-val").textContent,
        rem: document.getElementById("rem-val").textContent,
        deep: document.getElementById("deep-val").textContent,
        wake: document.getElementById("wake-val").textContent,
      };

      try {
        const response = await fetch("/generate_music", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(biometricData),
        });
        const result = await response.json();
        const audioPlayer = document.getElementById("audio-player");
        const audioSrc = document.getElementById("audio-src");

        if (result.status === "success") {
          audioSrc.src = result.url;
          audioPlayer.style.display = "block";
          audioPlayer.style.opacity = 0;
          audioPlayer.load();
          setTimeout(() => {
            audioPlayer.style.opacity = 1;
            statusMsg.textContent = "âœ… Musique gÃ©nÃ©rÃ©e avec succÃ¨s ! Profitez-en ğŸ§";
            statusMsg.style.color = "#55efc4";
            document.getElementById("track-name").textContent = result.filename;
            document.getElementById("feedback-section").style.display = "block";
          }, 500);

          lastPrompt = result.prompt;
          lastInputText = result.input_text;
        } else {
          statusMsg.textContent = "âŒ Erreur : " + result.message;
          statusMsg.style.color = "#ff7675";
        }
      } catch (err) {
        console.error("Erreur lors de la gÃ©nÃ©ration :", err);
        statusMsg.textContent = "âŒ Une erreur est survenue pendant la gÃ©nÃ©ration.";
        statusMsg.style.color = "#ff7675";
      }
    });

    document.querySelectorAll(".star").forEach((star, index) => {
      star.addEventListener("click", async () => {
        const rating = index + 1;
        document.querySelectorAll(".star").forEach((s, i) =>
          s.classList.toggle("selected", i <= index)
        );
        const feedbackMsg = document.getElementById("feedback-msg");
        feedbackMsg.textContent = `Merci pour votre note : ${rating} â­`;
        feedbackMsg.style.color = "#00b894";
        try {
          const res = await fetch("/submit_feedback", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              input_text: lastInputText,
              music_prompt: lastPrompt,
              score: rating,
            }),
          });
          const result = await res.json();
          console.log("âœ… Feedback envoyÃ© :", result.message);
        } catch (err) {
          console.error("âŒ Erreur lors de lâ€™envoi du feedback :", err);
          feedbackMsg.textContent = "Erreur lors de l'envoi du feedback.";
          feedbackMsg.style.color = "#d63031";
        }
      });
    });
  </script>
</body>

</html>
